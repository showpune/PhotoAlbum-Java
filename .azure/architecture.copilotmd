# PhotoAlbum-Java - Azure Architecture Diagram

> **Note**: Install a Mermaid preview extension in your IDE to render this architecture diagram.

## Architecture Overview

This diagram shows the Azure architecture for the PhotoAlbum-Java application, including all compute resources, dependencies, and their relationships.

```mermaid
graph TD
%% Services
svcazurecontainerapps_photoalbumapp["`Name: photoalbum-app
Path: /home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java
Language: java
Port: 8080
DockerFile: Dockerfile
Docker Context: ./`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps Environment"]
azurecontainerapps_photoalbumapp("`photoalbum-app (Azure Container App)`")
end
containerappenv:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azuredatabaseforpostgresql_photoalbumdb["`photoalbum-db (Azure Database for PostgreSQL)`"]
azurestorageaccount_photoalbumstorage["`photoalbum-storage (Azure Storage Account)`"]
azurecontainerregistry_photoalbumacr["`photoalbum-acr (Azure Container Registry)`"]
azurekeyvault_photoalbumkeyvault["`photoalbum-keyvault (Azure Key Vault)`"]
azureapplicationinsights_photoalbuminsights["`photoalbum-insights (Azure Application Insights)`"]
end
%% Relationships
svcazurecontainerapps_photoalbumapp --> |"hosted on"| azurecontainerapps_photoalbumapp
azurecontainerapps_photoalbumapp -.-> |"secret"| azuredatabaseforpostgresql_photoalbumdb
azurecontainerapps_photoalbumapp -.-> |"secret"| azurestorageaccount_photoalbumstorage
azurecontainerapps_photoalbumapp -.-> |"system-identity"| azurecontainerregistry_photoalbumacr
azurecontainerapps_photoalbumapp -.-> |"system-identity"| azurekeyvault_photoalbumkeyvault
azurecontainerapps_photoalbumapp -.-> |"secret"| azureapplicationinsights_photoalbuminsights
```

## Architecture Components

### Compute Layer

**Azure Container Apps Environment**
- Provides the hosting environment for containerized applications
- Manages networking, scaling, and infrastructure
- Serverless platform with consumption-based pricing

**photoalbum-app (Container App)**
- Spring Boot 2.7.18 application running on Java 8
- Containerized using Docker (multi-stage build)
- Exposes port 8080 for HTTP traffic
- Auto-scales based on HTTP requests (0-10 replicas)
- Ingress configured for external HTTPS access

### Data and Storage Layer

**Azure Database for PostgreSQL (photoalbum-db)**
- Flexible Server deployment
- Stores photo metadata (file names, sizes, dimensions, upload timestamps)
- Replaces Oracle Database from original architecture
- Connected via connection string stored in Key Vault
- Automatically managed backups and high availability

**Azure Storage Account (photoalbum-storage)**
- Blob Storage container for photo files
- Hot tier for frequently accessed images
- Replaces database BLOB storage from original architecture
- Private access with connection secured via Key Vault
- Scalable storage for unlimited photos

### Infrastructure Services

**Azure Container Registry (photoalbum-acr)**
- Private registry for Docker images
- Stores built container images
- Accessed via Managed Identity (AcrPull role)
- No credentials needed for pull operations

**Azure Key Vault (photoalbum-keyvault)**
- Secure storage for sensitive configuration
- Stores database connection strings
- Stores storage account keys
- Accessed via Managed Identity
- No secrets stored in application code

**Azure Application Insights (photoalbum-insights)**
- Application performance monitoring
- Tracks requests, dependencies, and exceptions
- Custom telemetry and logging
- Diagnostics and alerting
- Connected via instrumentation key

## Data Flow

### Photo Upload Flow
1. User uploads photo via web interface
2. Container App receives HTTP POST request
3. Application validates file (type, size)
4. Photo metadata saved to PostgreSQL database
5. Photo file uploaded to Azure Blob Storage
6. Success response returned to user
7. Telemetry sent to Application Insights

### Photo Retrieval Flow
1. User browses gallery or views photo detail
2. Container App queries PostgreSQL for metadata
3. Application generates signed URL for blob access
4. Photo served from Azure Blob Storage
5. Metadata displayed alongside photo
6. Page views tracked in Application Insights

### Authentication Flow
1. Container App authenticates to Azure services using Managed Identity
2. Database connections use credentials from Key Vault
3. Storage access uses keys from Key Vault
4. No credentials stored in environment variables or code

## Security Architecture

### Identity and Access Management
- **User-Assigned Managed Identity**: Primary authentication method
- **Key Vault Access**: Managed Identity has "Key Vault Secrets User" role
- **Container Registry Access**: Managed Identity has "AcrPull" role
- **No Stored Credentials**: All authentication via Azure AD and Key Vault

### Network Security
- **HTTPS Only**: All external traffic encrypted
- **Private Endpoints**: Optional for enhanced security
- **Firewall Rules**: PostgreSQL allows Azure services
- **Blob Storage**: No public access, authenticated requests only

### Data Security
- **Encryption at Rest**: All data encrypted in storage and database
- **Encryption in Transit**: TLS 1.2+ for all connections
- **Backup and Recovery**: Automated backups for database
- **Access Control**: RBAC for all Azure resources

## Scalability and Performance

### Auto-Scaling
- Container App scales from 0 to 10 replicas based on HTTP traffic
- Serverless architecture with pay-per-use pricing
- Automatic load balancing across replicas

### Performance Optimizations
- Blob Storage for efficient photo serving
- Database connection pooling
- Container image optimization (multi-stage build)
- Application Insights for performance monitoring

## Monitoring and Observability

### Application Insights Integration
- Request telemetry and response times
- Dependency tracking (database, storage)
- Exception logging and stack traces
- Custom events and metrics
- Live metrics streaming

### Log Analytics
- Centralized logging for all resources
- Query and analysis capabilities
- Alerting and dashboards
- Container logs and system metrics

## Supported Technologies

This architecture uses the following Azure services:

**Hosting**: containerapp

**Dependencies**: 
- azuredatabaseforpostgresql
- azurestorageaccount
- azurecontainerregistry
- azurekeyvault
- azureapplicationinsights

For other supported Azure services, refer to the Azure documentation.
