# Azure Deployment Plan for PhotoAlbum-Java Project

## **Goal**
Deploy the PhotoAlbum-Java Spring Boot application to Azure using Azure Developer CLI (azd), migrating from Oracle Database to Azure Database for PostgreSQL and from database BLOB storage to Azure Blob Storage.

## **Project Information**

**PhotoAlbum-Java**  
- **Stack**: Spring Boot 2.7.18 with Java 1.8  
- **Type**: Photo gallery web application with drag-and-drop upload, gallery view, and photo management
- **Framework**: Spring Boot with Thymeleaf templates, Spring Data JPA
- **Build System**: Maven
- **Containerization**: Dockerfile present (multi-stage build with Maven and OpenJDK 8)
- **Current Database**: Oracle Database 21c Express Edition (needs migration to Azure PostgreSQL)
- **Current Storage**: Photos stored as BLOBs in database (needs migration to Azure Blob Storage)
- **Dependencies**: 
  - Database (Oracle ‚Üí Azure PostgreSQL)
  - Photo Storage (Database BLOBs ‚Üí Azure Blob Storage)
  - Secrets Management (Azure Key Vault)
- **Hosting**: Azure Container Apps
- **Port**: 8080

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurecontainerapps_photoalbumapp["`Name: photoalbum-app
Path: /home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java
Language: java`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_photoalbumapp("`photoalbum-app (Azure Container App)`")
end
containerappenv:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azure_azuredatabaseforpostgresql["`Azure Database for PostgreSQL`"]
azure_azurestorageaccount["`Azure Storage Account (Blob Storage)`"]
azure_azurekeyvault["`Azure Key Vault`"]
azure_containerregistry["`Azure Container Registry`"]
azure_appinsights["`Application Insights`"]
end
%% Relationships
svcazurecontainerapps_photoalbumapp --> |"hosted on"| azurecontainerapps_photoalbumapp
azurecontainerapps_photoalbumapp -.-> |"depends on"| azure_azuredatabaseforpostgresql
azurecontainerapps_photoalbumapp -.-> |"depends on"| azure_azurestorageaccount
azurecontainerapps_photoalbumapp -.-> |"depends on"| azure_azurekeyvault
azurecontainerapps_photoalbumapp -.-> |"gets image from"| azure_containerregistry
azurecontainerapps_photoalbumapp -.-> |"monitored by"| azure_appinsights
azure_azurekeyvault -.-> |"stores connection strings"| azure_azuredatabaseforpostgresql
azure_azurekeyvault -.-> |"stores access keys"| azure_azurestorageaccount
```

**Resource Relationships:**
- The container app pulls its Docker image from Azure Container Registry
- The application connects to Azure Database for PostgreSQL for storing photo metadata
- The application uses Azure Blob Storage for storing photo files
- Connection strings and storage keys are securely stored in Azure Key Vault
- Application Insights provides monitoring and telemetry for the container app
- User-Assigned Managed Identity provides secure access to all Azure resources

## **Recommended Azure Resources**

### Application: PhotoAlbum-Java
- **Hosting Service Type**: Azure Container Apps
- **SKU**: Consumption plan with 0.5 vCPU and 1.0 GB memory (scales to zero, pay-per-use)
- **Performance**: Suitable for small to medium workloads with automatic scaling
- **Configuration**:
    - **Language**: java (Spring Boot 2.7.18, Java 1.8)
    - **Environment Variables**: 
      - `SPRING_DATASOURCE_URL`: PostgreSQL connection string (from Key Vault)
      - `SPRING_DATASOURCE_USERNAME`: Database username (from Key Vault)
      - `SPRING_DATASOURCE_PASSWORD`: Database password (from Key Vault)
      - `AZURE_STORAGE_ACCOUNT_NAME`: Storage account name
      - `AZURE_STORAGE_CONTAINER_NAME`: Blob container name (e.g., "photos")
      - `AZURE_STORAGE_CONNECTION_STRING`: Storage connection string (from Key Vault)
      - `APPLICATIONINSIGHTS_CONNECTION_STRING`: Application Insights connection string
      - `SERVER_PORT`: 8080
    - **dockerFilePath**: `/home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java/Dockerfile`
    - **dockerContext**: `/home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java`
    
- **Dependencies Resources**:
  
  1. **Azure Database for PostgreSQL**
     - **SKU**: Flexible Server, Burstable B1ms (1 vCore, 2 GiB RAM)
     - **Service Type**: Azure Database for PostgreSQL Flexible Server
     - **Connection Type**: Connection string with managed identity support
     - **Storage**: 32 GB
     - **Performance**: Suitable for development and small-scale production workloads
     - **Environment Variables**:
       - `POSTGRES_HOST`: Fully qualified server name
       - `POSTGRES_DATABASE`: Database name (e.g., "photoalbum")
       - `POSTGRES_USER`: Database username
       - `POSTGRES_PASSWORD`: Database password (stored in Key Vault)
     - **Notes**: Migration required from Oracle to PostgreSQL; JPA dialect needs update
  
  2. **Azure Blob Storage**
     - **SKU**: Standard General Purpose v2 (Locally-redundant storage - LRS)
     - **Service Type**: Azure Storage Account with Blob Storage
     - **Connection Type**: Connection string or managed identity with Storage Blob Data Contributor role
     - **Performance**: Hot tier for frequently accessed photos
     - **Environment Variables**:
       - `AZURE_STORAGE_ACCOUNT_NAME`: Storage account name
       - `AZURE_STORAGE_ACCOUNT_KEY`: Storage access key (stored in Key Vault)
       - `AZURE_STORAGE_CONNECTION_STRING`: Full connection string
     - **Notes**: Migration required from database BLOBs to Blob Storage; application code needs update
  
  3. **Azure Key Vault**
     - **SKU**: Standard tier
     - **Service Type**: Azure Key Vault
     - **Connection Type**: User-assigned managed identity with Key Vault Secrets User role
     - **Performance**: Sufficient for small to medium workloads
     - **Secrets Stored**:
       - `postgres-connection-string`: PostgreSQL connection string
       - `postgres-password`: Database password
       - `storage-connection-string`: Blob Storage connection string
       - `storage-account-key`: Storage account access key

## **Recommended Supporting Services**:
- **Application Insights**: For monitoring, logging, and telemetry collection from the container app
- **User-Assigned Managed Identity**: For secure, passwordless authentication to Azure services
- **Log Analytics Workspace**: Backend for Application Insights; collects all logs and metrics
- **Azure Container Registry**: For storing and managing Docker container images
- **Key Vault**: For secure storage of connection strings, passwords, and access keys

## **Recommended Security Configurations**:
- **User-Assigned Managed Identity** must have the following permissions:
  - **Key Vault Secrets User** role on the Key Vault
  - **Storage Blob Data Contributor** role on the Storage Account
  - **AcrPull** role (7f951dda-4ed3-4680-a7ca-43fe172d538d) on the Container Registry
- **User-Assigned Managed Identity** must be assigned to the Container App
- **Network Security**: Configure firewall rules on PostgreSQL to allow only Container App subnet
- **TLS/SSL**: Enforce SSL connections for PostgreSQL
- **HTTPS**: Configure HTTPS ingress for Container Apps
- **Access Policies**: Restrict Key Vault access to managed identity only

## **Execution Steps**
> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan. Add check list for the steps.**

### 1. Containerization:
- [x] Dockerfile exists at `/home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java/Dockerfile`
- [x] Repository analyzed using appmod-analyze-repository
- [ ] Verify Dockerfile is compatible with Azure Container Apps
- [ ] Test Docker build locally if needed
- **Output**: Docker artifacts verified

### 2. Create Azure Infrastructure Files for AZD:
- [ ] **Provisioning tool**: AZD
- [ ] **Expected files**: azure.yaml, infra/main.bicep, infra/main.parameters.json
- [ ] Get current subscription ID
- [ ] Call tool `appmod-get-available-region-sku` to get available regions and SKUs for:
  - Microsoft.App/containerApps
  - Microsoft.DBforPostgreSQL/flexibleServers
  - Microsoft.Storage/storageAccounts
  - Microsoft.KeyVault/vaults
  - Microsoft.ContainerRegistry/registries
  - Microsoft.Insights/components
- [ ] Check if expected files exist:
  - If **files exist**: 
    - Verify Azure resources match plan requirements
    - Update files if needed with missing resources
  - If **files do not exist**:
    - Call `appmod-get-iac-rules` with deploymentTool: "azd", iacType: "bicep", and resourceTypes
    - Generate azure.yaml with service definition
    - Generate infra/main.bicep with all required Azure resources
    - Generate infra/main.parameters.json with configurable parameters
- [ ] Validate generated Bicep files for syntax and deployment errors
- [ ] Fix any issues and retry validation
- **Output**: azure.yaml, infra/main.bicep, infra/main.parameters.json

### 3. Environment Setup for AZD:
- [ ] **Install prerequisites**:
  - [ ] Install Azure CLI (az) if not installed
  - [ ] Install Azure Developer CLI (azd) if not installed
  - [ ] Login to Azure: `az login`
  - [ ] Login to azd: `azd auth login`
- [ ] **Create azd environment**:
  - [ ] Run `azd env new <envName> --no-prompt` (suggest name: photoalbum-env)
  - [ ] If environment exists, verify it matches requirements
- [ ] **Set environment variables**:
  - [ ] Review infra/main.bicep and infra/main.parameters.json for required variables
  - [ ] Set AZURE_SUBSCRIPTION_ID: Use default subscription from `az account show`
  - [ ] Set AZURE_LOCATION: Use recommended region from step 2
  - [ ] Set AZURE_RESOURCE_GROUP: Create resource group with `az group create`
  - [ ] Set any additional required variables with `azd env set <key> <value>`
- **Output**: Configured azd environment ready for deployment

### 4. Deployment:
- [ ] **Preview infrastructure**:
  - [ ] Run `azd provision --preview --no-prompt` to validate infrastructure
  - [ ] Review and fix any validation errors
- [ ] **Deploy to Azure**:
  - [ ] Run `azd up --no-prompt` to provision infrastructure and deploy application
  - [ ] Monitor deployment progress
  - [ ] If deployment fails, capture error messages
  - [ ] Fix issues (may require region change - use `azd down --force --no-prompt` first)
  - [ ] Retry deployment until successful
- [ ] **Post-deployment validation**:
  - [ ] Call tool `appmod-get-azd-app-logs` to check application logs
  - [ ] Verify all services are running and healthy
  - [ ] Test application endpoints
  - [ ] Verify database connectivity
  - [ ] Verify blob storage access
- **Output**: Successfully deployed application on Azure

### 5. Database and Storage Migration:
- [ ] **Database Migration** (Oracle ‚Üí PostgreSQL):
  - [ ] Export data from Oracle database
  - [ ] Update application.properties for PostgreSQL:
    - Change dialect to `org.hibernate.dialect.PostgreSQLDialect`
    - Update JDBC URL format
    - Update driver class to `org.postgresql.Driver`
  - [ ] Add PostgreSQL JDBC driver dependency to pom.xml
  - [ ] Import data to Azure PostgreSQL
  - [ ] Test database connectivity and queries
- [ ] **Storage Migration** (Database BLOBs ‚Üí Azure Blob Storage):
  - [ ] Update PhotoService to use Azure Blob Storage SDK
  - [ ] Migrate existing photos from database to Blob Storage
  - [ ] Update Photo entity to store blob URLs instead of BLOB data
  - [ ] Test photo upload and retrieval
- **Output**: Migrated database and storage successfully

### 6. Summarize Deployment Result:
- [ ] Use `appmod-summarize-result` tool to summarize deployment
- [ ] Generate deployment summary document
- **Output**: .azure/summary.copilotmd

## **Progress Tracking**
- Copilot must create and update `.azure/progress.copilotmd` after each step.  
- Progress should include:  
  - ‚úÖ Completed tasks  
  - üî≤ Pending tasks  
  - ‚ùå Failed tasks with error notes

**Example format**:
- [x] Containerization complete (Dockerfile found at ./Dockerfile)
- [ ] Infrastructure files generation in progress
  - Attempt 1: Generated azure.yaml, infra/main.bicep, infra/main.parameters.json
  - Validating Bicep files...
- [ ] Deployment pending

If a script fails, log the error, regenerate/fix the script, and retry until the step completes.

## **Migration Considerations**

### Code Changes Required:
1. **Database Driver**: Update pom.xml to include PostgreSQL JDBC driver
2. **JPA Configuration**: Change Hibernate dialect to PostgreSQL
3. **Blob Storage**: Implement Azure Blob Storage SDK for photo storage
4. **Configuration**: Externalize configuration to use Azure Key Vault references
5. **Health Checks**: Add readiness and liveness probes for Container Apps

### Testing Strategy:
1. Test Docker build locally
2. Test PostgreSQL connectivity with test database
3. Test Azure Blob Storage operations
4. Perform integration testing before production deployment
5. Load testing for Container Apps scaling configuration

### Rollback Plan:
1. Keep Oracle database running during migration
2. Maintain backup of existing photos
3. Use azd down to remove Azure resources if needed
4. Document rollback procedures in case of issues
