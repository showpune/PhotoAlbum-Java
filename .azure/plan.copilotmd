# Azure Deployment Plan for PhotoAlbum-Java Project

## **Goal**
Migrate the PhotoAlbum-Java application from a local Docker environment with Oracle Database to Azure using Azure Developer CLI (AZD). The application will be deployed to Azure Container Apps with PostgreSQL Flexible Server as the database backend.

## **Project Information**

**PhotoAlbum-Java**  
- **Stack**: Spring Boot 2.7.18 (Java 8)
- **Framework**: Spring Boot with JPA/Hibernate, Thymeleaf templating
- **Type**: Photo gallery web application with drag-and-drop upload, gallery view, and photo management
- **Database**: Currently Oracle Database 21c (will migrate to PostgreSQL)
- **Storage**: Photo BLOBs stored in database
- **Containerization**: Dockerfile present (Maven-based multi-stage build)
- **Dependencies**: PostgreSQL Flexible Server, Azure Container Registry
- **Hosting**: Azure Container Apps
- **Port**: 8080

## **Azure Resources Architecture**

> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurecontainerapps_photoalbumjavaapp["`Name: photoalbum-java-app
Path: /home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java
Language: java`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_photoalbumjavaapp("`photoalbum-java-app (Azure Container App)`")
end
containerappenv:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azure_azuredatabaseforpostgresql["`PostgreSQL Flexible Server`"]
azure_azurecontainerregistry["`Azure Container Registry`"]
azure_keyvault["`Azure Key Vault`"]
azure_loganalytics["`Log Analytics Workspace`"]
azure_appinsights["`Application Insights`"]
azure_managedidentity["`User-Assigned Managed Identity`"]
end
%% Relationships
svcazurecontainerapps_photoalbumjavaapp --> |"hosted on"| azurecontainerapps_photoalbumjavaapp
azurecontainerapps_photoalbumjavaapp -.-> |"uses identity"| azure_managedidentity
azurecontainerapps_photoalbumjavaapp -.-> |"pulls image from"| azure_azurecontainerregistry
azurecontainerapps_photoalbumjavaapp -.-> |"connects to"| azure_azuredatabaseforpostgresql
azurecontainerapps_photoalbumjavaapp -.-> |"reads secrets from"| azure_keyvault
azurecontainerapps_photoalbumjavaapp -.-> |"logs to"| azure_loganalytics
azurecontainerapps_photoalbumjavaapp -.-> |"telemetry to"| azure_appinsights
azure_managedidentity -.-> |"accesses"| azure_keyvault
azure_managedidentity -.-> |"pulls from"| azure_azurecontainerregistry
```

**Architecture Summary:**
- The container app gets its Docker image from the Azure Container Registry.
- The container app connects to PostgreSQL Flexible Server for photo metadata and BLOB storage.
- The app uses User-Assigned Managed Identity for secure access to Key Vault and Container Registry.
- Database connection strings are stored securely in Azure Key Vault.
- Application logs and metrics are sent to Log Analytics Workspace and Application Insights.

## **Recommended Azure Resources**

### Application: PhotoAlbum-Java

#### Hosting Service:
- **Service Type**: Azure Container Apps
- **SKU**: Consumption plan with autoscaling (0-10 replicas)
- **Configuration**:
    - **Language**: Java 8
    - **Runtime**: Eclipse Temurin 8 JRE
    - **Port**: 8080
    - **CPU**: 0.5 vCPU per replica
    - **Memory**: 1 Gi per replica
    - **Environment Variables**:
        - `SPRING_PROFILES_ACTIVE`: azure
        - `SPRING_DATASOURCE_URL`: ${postgres-connection-string}
        - `SPRING_DATASOURCE_USERNAME`: ${postgres-username}
        - `SPRING_DATASOURCE_PASSWORD`: ${postgres-password}
        - `SPRING_DATASOURCE_DRIVER_CLASS_NAME`: org.postgresql.Driver
        - `SPRING_JPA_DATABASE_PLATFORM`: org.hibernate.dialect.PostgreSQLDialect
        - `JAVA_OPTS`: -Xmx512m -Xms256m
        - `APPLICATIONINSIGHTS_CONNECTION_STRING`: ${appinsights-connection-string}
    - **dockerFilePath**: /home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java/Dockerfile
    - **dockerContext**: /home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java

#### Dependencies:

##### 1. PostgreSQL Flexible Server
- **Dependency Name**: photoalbum-postgresql
- **SKU**: Burstable B1ms (1 vCore, 2 GiB RAM) - suitable for development/testing
- **Service Type**: Azure Database for PostgreSQL - Flexible Server
- **Version**: 15
- **Storage**: 32 GB, auto-grow enabled
- **Backup Retention**: 7 days
- **Connection Type**: Connection string with username/password (stored in Key Vault)
- **Database Name**: photoalbum
- **Firewall**: Allow Azure services
- **Environment Variables**:
    - `POSTGRES_SERVER`: ${postgres-server-fqdn}
    - `POSTGRES_USER`: photoalbum
    - `POSTGRES_PASSWORD`: ${secure-password}
    - `POSTGRES_DATABASE`: photoalbum

##### 2. Azure Container Registry
- **Dependency Name**: photoalbumacr
- **SKU**: Basic (1 vCPU, 1.75 GiB RAM, 10 GB storage)
- **Service Type**: Azure Container Registry
- **Connection Type**: Managed Identity with AcrPull role
- **Features**: 
    - Admin user disabled (using Managed Identity)
    - Geo-replication: Not enabled (Basic SKU)
    - Container scanning: Available

## **Recommended Supporting Services**

### 1. Application Insights
- **Purpose**: Application performance monitoring and telemetry
- **Integration**: Automatic instrumentation for Spring Boot
- **Features**: Request tracking, dependency monitoring, exception logging

### 2. User-Assigned Managed Identity
- **Purpose**: Secure, credential-free authentication
- **Permissions**:
    - Key Vault Secrets User role on Key Vault
    - AcrPull role on Container Registry

### 3. Log Analytics Workspace
- **Purpose**: Centralized logging and diagnostics
- **Integration**: Container Apps environment logs to this workspace
- **Retention**: 30 days

### 4. Key Vault
- **Purpose**: Secure storage of database connection strings and credentials
- **Secrets**:
    - postgres-connection-string
    - postgres-username
    - postgres-password
- **Access Policy**: User-Assigned Managed Identity has Get/List permissions

### 5. Container Apps Environment
- **Purpose**: Hosting environment for Container Apps
- **Configuration**: Integrated with Log Analytics Workspace and Application Insights

## **Recommended Security Configurations**

1. **Managed Identity Permissions**:
   - User-Assigned Managed Identity must have "Key Vault Secrets User" role on Key Vault
   - User-Assigned Managed Identity must be assigned to the Container App
   - User-Assigned Managed Identity must have AcrPull role (7f951dda-4ed3-4680-a7ca-43fe172d538d) on Container Registry

2. **Network Security**:
   - PostgreSQL Flexible Server: Allow Azure services, restrict public access
   - Container Registry: Disable admin user, use Managed Identity only
   - Key Vault: Network access restricted to Azure services

3. **Secrets Management**:
   - All sensitive data (passwords, connection strings) stored in Key Vault
   - Container App references Key Vault secrets, not plain text values
   - No hardcoded credentials in code or configuration files

4. **Database Security**:
   - PostgreSQL: SSL/TLS enforced for connections
   - Application user has minimal required privileges
   - Regular automated backups enabled

## **Database Migration Considerations**

The application currently uses Oracle Database and needs to be migrated to PostgreSQL:

### Schema Changes:
- Oracle `VARCHAR2` ‚Üí PostgreSQL `VARCHAR`
- Oracle `NUMBER` ‚Üí PostgreSQL `NUMERIC` or `INTEGER`
- Oracle `BLOB` ‚Üí PostgreSQL `BYTEA` or `OID`
- Oracle `SYSTIMESTAMP` ‚Üí PostgreSQL `CURRENT_TIMESTAMP`
- Oracle sequence generation ‚Üí PostgreSQL serial or UUID

### Application Changes:
- Update JPA dialect from `OracleDialect` to `PostgreSQLDialect`
- Update JDBC driver from `ojdbc8` to `postgresql`
- Update connection URL format
- Test BLOB storage operations (photo data)
- Verify UUID generation compatibility

### Maven Dependency Changes:
```xml
<!-- Remove Oracle JDBC -->
<!-- <dependency>
    <groupId>com.oracle.database.jdbc</groupId>
    <artifactId>ojdbc8</artifactId>
</dependency> -->

<!-- Add PostgreSQL JDBC -->
<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
    <scope>runtime</scope>
</dependency>
```

## **Execution Steps**

> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan. Add check list for the steps.**

### Phase 1: Preparation and Analysis
- [ ] 1.1. Verify repository structure and current Docker setup
- [ ] 1.2. Analyze existing Dockerfile for Azure compatibility
- [ ] 1.3. Review application configuration files

### Phase 2: Database Migration Preparation
- [ ] 2.1. Update Maven pom.xml to add PostgreSQL driver dependency
- [ ] 2.2. Create Azure profile configuration (application-azure.properties)
- [ ] 2.3. Update JPA configuration for PostgreSQL dialect
- [ ] 2.4. Verify BLOB handling works with PostgreSQL BYTEA

### Phase 3: Containerization
- [ ] 3.1. Review existing Dockerfile at `/home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java/Dockerfile`
- [ ] 3.2. If needed, use `appmod-plan-generate-dockerfile` to optimize for Azure
- [ ] 3.3. Test local Docker build with PostgreSQL
- [ ] 3.4. Output: Docker artifacts ready for Azure

### Phase 4: Azure Infrastructure Setup (AZD)
- [ ] 4.1. Check for existing AZD files (azure.yaml, infra/main.bicep, infra/main.parameters.json)
- [ ] 4.2. Call `appmod-get-available-region-sku` to get available regions and SKUs for:
    - Microsoft.App/containerApps
    - Microsoft.DBforPostgreSQL/flexibleServers
    - Microsoft.ContainerRegistry/registries
    - Microsoft.KeyVault/vaults
    - Microsoft.Insights/components
- [ ] 4.3. Call `appmod-get-iac-rules` to get Bicep generation rules for azd deployment
- [ ] 4.4. Generate required files:
    - `azure.yaml` (AZD project definition)
    - `infra/main.bicep` (Infrastructure as Code)
    - `infra/main.parameters.json` (Parameters)
    - `infra/resources.bicep` (Resource definitions)
    - `infra/app` module files as needed
- [ ] 4.5. Validate Bicep files for syntax errors
- [ ] 4.6. Fix any errors and retry validation

### Phase 5: Environment Setup for AZD
- [ ] 5.1. Install Azure CLI (az) if not already installed
- [ ] 5.2. Install Azure Developer CLI (azd) if not already installed
- [ ] 5.3. Login to Azure: `az login`
- [ ] 5.4. Create new AZD environment: `azd env new <envName> --no-prompt`
- [ ] 5.5. Set subscription: Use default subscription from `az account show`
- [ ] 5.6. Set environment variables using `azd env set`:
    - `AZURE_SUBSCRIPTION_ID`
    - `AZURE_LOCATION` (from available regions)
    - `AZURE_RESOURCE_GROUP` (create with az cli first)
    - `POSTGRES_ADMIN_PASSWORD` (secure, random)
    - Other required parameters from main.parameters.json
- [ ] 5.7. Create resource group with Azure CLI if Bicep uses resource group scope

### Phase 6: Deployment
- [ ] 6.1. Dry run infrastructure: `azd provision --preview --no-prompt`
- [ ] 6.2. Review preview output for any issues
- [ ] 6.3. Full deployment: `azd up --no-prompt`
- [ ] 6.4. Monitor deployment progress and logs
- [ ] 6.5. If deployment fails:
    - Review error messages
    - Fix configuration issues
    - If region issues: `azd down --force --no-prompt` then retry with new region
    - Iterate and retry until successful

### Phase 7: Deployment Validation
- [ ] 7.1. Use `appmod-get-azd-app-logs` to check application logs
- [ ] 7.2. Verify database connection is successful
- [ ] 7.3. Test photo upload functionality
- [ ] 7.4. Test photo retrieval and display
- [ ] 7.5. Test photo deletion
- [ ] 7.6. Verify Application Insights is receiving telemetry
- [ ] 7.7. Check Key Vault access is working

### Phase 8: Summary and Documentation
- [ ] 8.1. Use `appmod-summarize-result` to create deployment summary
- [ ] 8.2. Generate `.azure/summary.copilotmd` with:
    - Deployment status
    - Created resources list
    - Application URLs
    - Configuration details
    - Post-deployment recommendations
- [ ] 8.3. Document any manual steps required
- [ ] 8.4. Provide connection strings and endpoints

## **Progress Tracking**

Progress will be tracked in `.azure/progress.copilotmd` after each step.

**Format:**
- ‚úÖ [x] Completed tasks
- üî≤ [ ] Pending tasks  
- ‚ùå [ ] Failed tasks with error notes

**Example:**
```
- [x] Phase 1: Repository analysis complete
- [x] Phase 2: Database migration prepared (PostgreSQL driver added)
- [x] Phase 3: Containerization validated (Dockerfile ready)
- [ ] Phase 4: Azure infrastructure setup
  - [x] Called appmod-get-available-region-sku (westus2 selected)
  - [x] Generated azure.yaml
  - [ ] Generating Bicep files
    - Attempt 1: Syntax error in main.bicep (missing parameter)
    - Fixed by adding required parameter. Retrying validation...
```

If a script or step fails, the error will be logged, the script regenerated/fixed, and retried until completion.

## **Post-Deployment Tasks**

After successful deployment:

1. **DNS Configuration**: Configure custom domain if required
2. **SSL Certificates**: Enable HTTPS with managed certificates
3. **Scaling Rules**: Configure autoscaling based on HTTP requests or CPU
4. **Monitoring Alerts**: Set up alerts for failures, high latency, or errors
5. **Backup Verification**: Verify PostgreSQL backups are running
6. **Cost Optimization**: Review resource utilization and adjust SKUs if needed
7. **CI/CD Pipeline**: Set up GitHub Actions for automated deployments

## **Estimated Migration Timeline**

- Database preparation: 30 minutes
- Infrastructure setup: 45 minutes
- Initial deployment: 30 minutes
- Testing and validation: 45 minutes
- **Total: ~2.5 hours**

## **Notes and Considerations**

1. **Oracle to PostgreSQL**: This is a significant change. Thorough testing is required.
2. **BLOB Storage**: Photo storage in PostgreSQL BYTEA has size limitations. Consider Azure Blob Storage for production.
3. **Performance**: Burstable B1ms SKU is suitable for development. Production may need higher SKU.
4. **Cost**: Basic/Burstable SKUs keep costs low. Monitor usage and scale as needed.
5. **Data Migration**: This plan creates new infrastructure. Existing Oracle data needs separate migration strategy.
