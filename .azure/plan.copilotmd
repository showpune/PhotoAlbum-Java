# Azure Deployment Plan for PhotoAlbum-Java Project

## **Goal**
Deploy the PhotoAlbum-Java Spring Boot application to Azure using Azure Developer CLI (AZD) with Azure Container Apps as the hosting platform.

## **Project Information**

**PhotoAlbum-Java**
- **Stack**: Spring Boot 2.7.18 (Java 8), Thymeleaf, Spring Data JPA
- **Type**: Photo gallery web application with upload, gallery view, and photo management features
- **Containerization**: Dockerfile present (multi-stage build with Maven and OpenJDK)
- **Current Database**: Oracle Database 21c Express Edition (to be migrated to PostgreSQL)
- **Current Storage**: Photos stored as BLOBs in database (to be migrated to Azure Blob Storage)
- **Hosting**: Azure Container Apps
- **Port**: 8080

## **Azure Resources Architecture**

> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurecontainerapps_photoalbumapp["`Name: photoalbum-app
Path: /home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java
Language: java`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps Environment"]
azurecontainerapps_photoalbumapp("`photoalbum-app (Azure Container App)`")
end
containerappenv:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azure_postgresql["`Azure Database for PostgreSQL Flexible Server`"]
azure_storage["`Azure Storage Account (Blob Storage)`"]
azure_acr["`Azure Container Registry`"]
azure_keyvault["`Azure Key Vault`"]
azure_appinsights["`Azure Application Insights`"]
azure_loganalytics["`Log Analytics Workspace`"]
end
%% Relationships
svcazurecontainerapps_photoalbumapp --> |"hosted on"| azurecontainerapps_photoalbumapp
azurecontainerapps_photoalbumapp -.-> |"depends on"| azure_postgresql
azurecontainerapps_photoalbumapp -.-> |"depends on"| azure_storage
azurecontainerapps_photoalbumapp -.-> |"depends on"| azure_acr
azurecontainerapps_photoalbumapp -.-> |"depends on"| azure_keyvault
azurecontainerapps_photoalbumapp -.-> |"depends on"| azure_appinsights
azurecontainerapps_photoalbumapp -.-> |"depends on"| azure_loganalytics
```

**Resource Relationships:**
- The container app gets its Docker image from the Azure Container Registry
- The container app connects to Azure Database for PostgreSQL for relational data storage (photo metadata)
- The container app uses Azure Blob Storage for storing actual photo files
- The container app retrieves database connection strings and storage keys from Azure Key Vault
- The container app sends telemetry and logs to Application Insights and Log Analytics Workspace
- User-Assigned Managed Identity provides secure access to all Azure resources without storing credentials

## **Recommended Azure Resources**

### Application: PhotoAlbum-Java

**Hosting Service:**
- **Type**: Azure Container Apps
- **SKU**: Consumption (Serverless)
  - Auto-scaling from 0 to 10 replicas
  - CPU: 0.5 cores, Memory: 1.0 GB per replica
  - Suitable for variable workloads with automatic scaling
- **Configuration**:
  - Language: Java 8
  - Runtime: OpenJDK 8 JRE (eclipse-temurin:8-jre)
  - dockerFilePath: `/home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java/Dockerfile`
  - dockerContext: `/home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java`
  - Port: 8080
  - Ingress: External with HTTPS
  - Environment Variables:
    - `SPRING_DATASOURCE_URL` - PostgreSQL connection string
    - `SPRING_DATASOURCE_USERNAME` - Database username
    - `SPRING_DATASOURCE_PASSWORD` - Database password (from Key Vault)
    - `AZURE_STORAGE_ACCOUNT_NAME` - Storage account name
    - `AZURE_STORAGE_ACCOUNT_KEY` - Storage account key (from Key Vault)
    - `AZURE_STORAGE_CONTAINER_NAME` - Blob container name (default: photos)
    - `APPLICATIONINSIGHTS_CONNECTION_STRING` - Application Insights connection string

### Dependency Resources:

#### 1. Azure Database for PostgreSQL Flexible Server
- **Service Type**: Azure Database for PostgreSQL Flexible Server
- **SKU**: Burstable B1ms (1 vCore, 2 GiB memory)
  - Suitable for development and moderate workloads
  - Auto-scaling storage up to 32 GiB
- **Connection Type**: Connection string with username/password stored in Key Vault
- **Configuration**:
  - PostgreSQL Version: 15
  - Storage: 32 GB with auto-grow enabled
  - Backup retention: 7 days
  - High Availability: Zone-redundant (for production)
- **Environment Variables**:
  - `POSTGRES_HOST` - Server hostname
  - `POSTGRES_PORT` - 5432
  - `POSTGRES_DATABASE` - photoalbum
  - `POSTGRES_USER` - photoalbumadmin
  - `POSTGRES_PASSWORD` - Stored in Key Vault

#### 2. Azure Storage Account (Blob Storage)
- **Service Type**: Azure Storage Account
- **SKU**: Standard_LRS (Locally Redundant Storage)
  - Hot tier for frequently accessed photos
  - Suitable for application data with local redundancy
- **Connection Type**: Storage account key (stored in Key Vault) or Managed Identity
- **Configuration**:
  - Container Name: photos
  - Public Access: None (private)
  - HTTPS Only: Enabled
- **Environment Variables**:
  - `AZURE_STORAGE_ACCOUNT_NAME` - Storage account name
  - `AZURE_STORAGE_ACCOUNT_KEY` - Account key (from Key Vault)
  - `AZURE_STORAGE_BLOB_ENDPOINT` - Blob endpoint URL

#### 3. Azure Container Registry
- **Service Type**: Azure Container Registry
- **SKU**: Basic
  - 10 GB storage included
  - Suitable for development and small-scale production
- **Connection Type**: Managed Identity (AcrPull role)
- **Configuration**:
  - Admin user: Disabled
  - Anonymous pull: Disabled
  - Managed Identity access: Enabled

## **Recommended Supporting Services**

1. **Application Insights**
   - Monitor application performance and availability
   - Track custom metrics and events
   - Log analytics and diagnostics

2. **User-Assigned Managed Identity**
   - Secure authentication to Azure services
   - No credential storage in application
   - Automatic token management

3. **Log Analytics Workspace**
   - Centralized logging for all Azure resources
   - Container app logs and metrics
   - Query and alert capabilities

4. **Azure Key Vault**
   - Secure storage for database connection strings
   - Storage account keys
   - Application secrets
   - Access via Managed Identity

## **Recommended Security Configurations**

1. **Managed Identity Permissions**:
   - User-Assigned Managed Identity must have "Key Vault Secrets User" role on Key Vault
   - User-Assigned Managed Identity must have "AcrPull" role (7f951dda-4ed3-4680-a7ca-43fe172d538d) on Container Registry
   - User-Assigned Managed Identity must be assigned to the Container App

2. **Network Security**:
   - Container App ingress restricted to HTTPS only
   - PostgreSQL firewall configured to allow Azure services
   - Blob Storage with no public access
   - Key Vault with network restrictions (optional)

3. **Secrets Management**:
   - All sensitive configuration stored in Key Vault
   - No hardcoded credentials in code or configuration
   - Environment variables reference Key Vault secrets

4. **Database Security**:
   - Strong password for PostgreSQL admin
   - SSL/TLS enforced for database connections
   - Regular automated backups

## **Execution Steps**

> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan. Add check list for the steps.**

### 1. Containerization
- [x] Dockerfile exists at `/home/runner/work/PhotoAlbum-Java/PhotoAlbum-Java/Dockerfile`
- [ ] Verify Dockerfile is optimized for Azure deployment
- [ ] Test Docker build locally (optional)
- Output: Docker artifacts ready

### 2. Create Azure Infrastructure Files for AZD

#### 2.1 Provisioning Setup
- Provisioning tool: AZD
- Expected files: `azure.yaml`, `infra/main.bicep`, `infra/main.parameters.json`

#### 2.2 Check Subscription and Available Regions
- [ ] Get current Azure subscription ID
- [ ] Call tool `appmod-get-available-region-sku` to get available regions and SKUs for:
  - Microsoft.App/containerApps
  - Microsoft.DBforPostgreSQL/flexibleServers
  - Microsoft.Storage/storageAccounts
  - Microsoft.ContainerRegistry/registries
  - Microsoft.KeyVault/vaults
  - Microsoft.Insights/components

#### 2.3 Generate Infrastructure Files
- [ ] Check if `azure.yaml`, `infra/main.bicep`, `infra/main.parameters.json` exist
- [ ] If files do not exist:
  - [ ] Call tool `appmod-get-iac-rules` to get rules for Bicep generation
  - [ ] Generate `azure.yaml` with service configuration
  - [ ] Generate `infra/main.bicep` with all required Azure resources:
    - Container Apps Environment
    - Container App
    - PostgreSQL Flexible Server
    - Storage Account with blob container
    - Container Registry
    - Key Vault
    - Application Insights
    - Log Analytics Workspace
    - User-Assigned Managed Identity
    - Role assignments
  - [ ] Generate `infra/main.parameters.json` with parameter values
  - [ ] Call `get_errors` tool to validate generated files
  - [ ] Fix any errors and regenerate if needed

- [ ] If files exist:
  - [ ] Verify existing files match required resources
  - [ ] Update files if missing resources

### 3. Environment Setup for AZD

#### 3.1 Install Prerequisites
- [ ] Check if Azure CLI is installed, install if missing
- [ ] Check if Azure Developer CLI (azd) is installed, install if missing

#### 3.2 Create AZD Environment
- [ ] Run `azd env new photoalbum-env --no-prompt` to create new environment
- [ ] If environment exists, verify it matches requirements

#### 3.3 Configure Environment Variables
- [ ] Review `infra/main.bicep` and `infra/main.parameters.json` for required variables
- [ ] Set environment variables using `azd env set`:
  - [ ] `AZURE_SUBSCRIPTION_ID` - Use default subscription from Azure CLI
  - [ ] `AZURE_LOCATION` - Use available region from step 2.2
  - [ ] `AZURE_RESOURCE_GROUP` - Set to `photoalbum-rg`
  - [ ] `POSTGRES_ADMIN_PASSWORD` - Generate secure password
  - [ ] Additional variables as needed

#### 3.4 Create Resource Group
- [ ] Check if Bicep uses resource group scope
- [ ] Create resource group using Azure CLI: `az group create --name photoalbum-rg --location <region>`

### 4. Deployment

#### 4.1 Preview Infrastructure
- [ ] Run `azd provision --preview --no-prompt` to dry run infrastructure
- [ ] Verify all resources are correctly configured
- [ ] Fix any validation errors

#### 4.2 Deploy to Azure
- [ ] Run `azd up --no-prompt` to provision infrastructure and deploy application
- [ ] Monitor deployment progress
- [ ] If errors occur:
  - [ ] Analyze error messages
  - [ ] Fix configuration or code issues
  - [ ] Retry deployment
- [ ] If region change needed:
  - [ ] Run `azd down --force --no-prompt` to clean up
  - [ ] Update region configuration
  - [ ] Retry deployment

#### 4.3 Deployment Validation
- [ ] Check application logs using `appmod-get-azd-app-logs` tool
- [ ] Verify services are running
- [ ] Test application endpoints:
  - [ ] Home page loads
  - [ ] Photo upload works
  - [ ] Gallery view displays
  - [ ] Photo detail view works
  - [ ] Delete functionality works
- [ ] Verify database connectivity
- [ ] Verify blob storage connectivity

### 5. Summarize Deployment Result
- [ ] Use `appmod-summarize-result` tool to generate deployment summary
- [ ] Generate file: `.azure/summary.copilotmd`
- [ ] Document:
  - Deployed resources
  - Application URLs
  - Configuration details
  - Any issues encountered
  - Next steps

## **Progress Tracking**

Copilot must create and update `.azure/progress.copilotmd` after each step.

Progress should include:
- ‚úÖ Completed tasks
- üî≤ Pending tasks
- ‚ùå Failed tasks with error notes

If a script fails, log the error, regenerate/fix the script, and retry until the step completes.

Example format:
- [x] Containerization complete (Dockerfile found at ./Dockerfile)
- [ ] Deployment in progress
  - Attempt 1 failed: ACR push error (unauthorized).
  - Fixed by regenerating deploy script with correct az acr login. Retrying...

## **Migration Notes**

### Database Migration from Oracle to PostgreSQL
1. **Schema Changes Required**:
   - Update `pom.xml` to replace Oracle JDBC driver with PostgreSQL driver
   - Change Hibernate dialect from Oracle to PostgreSQL
   - Test schema generation with PostgreSQL

2. **Data Migration**:
   - Export existing Oracle data (if any)
   - Import to Azure Database for PostgreSQL
   - Verify data integrity

### Storage Migration from Database BLOBs to Azure Blob Storage
1. **Code Changes Required**:
   - Add Azure Storage Blob SDK dependency
   - Create PhotoStorageService for Azure Blob operations
   - Update PhotoService to use PhotoStorageService
   - Modify upload endpoint to save files to Blob Storage
   - Modify retrieval endpoint to fetch from Blob Storage
   - Update Photo entity to remove BLOB field

2. **Benefits**:
   - Improved scalability for photo storage
   - Reduced database size and improved performance
   - CDN integration capabilities
   - Cost optimization

## **Post-Deployment Tasks**

1. **Testing**:
   - Comprehensive functional testing of all features
   - Performance testing under load
   - Security testing

2. **Monitoring Setup**:
   - Configure Application Insights dashboards
   - Set up alerts for errors and performance issues
   - Configure log retention policies

3. **Documentation**:
   - Update README with Azure deployment instructions
   - Document environment variables and configuration
   - Create runbook for common operations

4. **Optimization**:
   - Review and optimize container app scaling rules
   - Implement caching strategies
   - Configure CDN for static assets (optional)

5. **Security Hardening**:
   - Review and tighten network security rules
   - Enable Azure Defender for Cloud
   - Configure backup and disaster recovery
